<!DOCTYPE html>
<html>
<head>
    <title>Emotion Recognition</title>
    <style>
        body {
            text-align: center;
            margin-top: 100px;
        }

        #video-player {
            margin-top: 20px;
        }

        canvas {
            display: none;
        }
    </style>
</head>
<body>
    <h1>Emotion Recognition</h1>

    <video id="video-player" width="640" height="480" autoplay></video>
    <canvas id="canvas" width="640" height="480"></canvas>

    <script async src="https://docs.opencv.org/master/opencv.js" onload="onOpenCvLoaded();" type="text/javascript"></script>
    <script src="https://sdk.scdn.co/spotify-player.js"></script>
    <script type="text/javascript">
        let videoPlayer, canvas, context, cv;
        let spotifyPlayer;

        function onOpenCvLoaded() {
            // ... existing code ...

            // Start the emotion recognition process
            startEmotionRecognition();
        }

        async function startEmotionRecognition() {
            // ... existing code ...

            // Authenticate with Sotify API
            const clientId = 'd05d2efe136140a692c041aeb31f0bb5';
            const clientSecret = 'bd54f8c6c7c1449ca65d965b2e9ed5ba';
            const encodedCredentials = btoa(`${clientId}:${clientSecret}`);
            const tokenResponse = await fetch('https://accounts.spotify.com/api/token', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'Authorization': `Basic ${encodedCredentials}`,
                },
                body: 'grant_type=client_credentials',
            });
            const tokenData = await tokenResponse.json();
            const accessToken = tokenData.access_token;

            // Search for songs based on emotion
            const emotions = ['Angry', 'Disgust', 'Fear', 'Happy', 'Sad', 'Surprise', 'Neutral'];
            const detectedEmotionIndex = prediction.argMax(1).dataSync()[0]; // Obtain the detected emotion index from the emotion recognition process
            const detectedEmotion = emotions[detectedEmotionIndex];

            const searchResponse = await fetch(`https://api.spotify.com/v1/search?q=${detectedEmotion}&type=track`, {
                headers: {
                    'Authorization': `Bearer ${accessToken}`,
                },
            });
            const searchData = await searchResponse.json();
            const tracks = searchData.tracks.items;

            // Play songs using Spotify Web Playback SDK
            const deviceId = devices[0].id // Obtain the Spotify device ID to play the songs on
            spotifyPlayer = new Spotify.Player({
                name: 'Emotion Recognition Player',
                getOAuthToken: callback => {
                    callback(accessToken);
                },
                volume: 0.5,
            });

            spotifyPlayer.addListener('ready', ({ device_id }) => {
                console.log('Ready with Device ID', device_id);

                spotifyPlayer.device_id = device_id;
                spotifyPlayer.connect();

                // Play the first song in the recommended tracks
                spotifyPlayer.addListener('ready', () => {
                    const firstTrack = tracks[0];
                    spotifyPlayer._options.getOAuthToken(accessToken => {
                        fetch(`https://api.spotify.com/v1/me/player/play?device_id=${device_id}`, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${accessToken}`,
                            },
                            body: JSON.stringify({
                                uris: [firstTrack.uri],
                            }),
                        });
                    });
                });
            });

            spotifyPlayer.addListener('not_ready', ({ device_id }) => {
                console.log('Device ID has gone offline', device_id);
            });
        }
    </script>
</body>
</html>
